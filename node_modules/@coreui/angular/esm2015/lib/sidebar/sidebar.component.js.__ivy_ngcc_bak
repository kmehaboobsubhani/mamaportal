import { Component, ElementRef, HostBinding, Inject, Input, Renderer2 } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { BreakpointObserver } from '@angular/cdk/layout';
import classNames from 'classnames';
import { SidebarService } from './sidebar.service';
export class SidebarComponent {
    constructor(document, renderer, hostElement, breakpointObserver, sidebarService) {
        this.document = document;
        this.renderer = renderer;
        this.hostElement = hostElement;
        this.breakpointObserver = breakpointObserver;
        this.sidebarService = sidebarService;
        this.fixed = true;
        this.unfoldable = false;
        this.overlaid = false;
        this.minimize = false;
        this.breakpoint = 'lg';
        this.mobile = 'lg';
        this.size = '';
        this.hideOnMobileClick = true;
        this.colorScheme = 'dark';
        this.minimized = this.minimize;
    }
    get getClasses() {
        return this.hostClasses;
    }
    get getDesktopBreakpoint() {
        return getComputedStyle(this.hostElement.nativeElement).getPropertyValue(`--breakpoint-${this.breakpoint}`);
    }
    get hasBreakpoint() {
        return !!this.breakpoint;
    }
    get getMobileBreakpoint() {
        return getComputedStyle(this.hostElement.nativeElement).getPropertyValue(`--breakpoint-${this.mobile}`);
    }
    set isOnMobile(value) {
        this._isOnMobile = value;
    }
    get isOnMobile() {
        const isMobile = Boolean(this._isOnMobile);
        return isMobile;
    }
    set isOnDesktop(value) {
        this._isOnDesktop = this.hasBreakpoint ? value : false;
    }
    get isOnDesktop() {
        return this._isOnDesktop;
    }
    get isOpen() {
        let opened;
        if (this.isOnDesktop) {
            opened = this.openDesktop;
        }
        else {
            opened = (this.openMobile === true);
        }
        return opened;
    }
    get hostClasses() {
        const classes = classNames({
            'c-sidebar': true,
            'c-sidebar-fixed': this.fixed && !this.overlaid,
            'c-sidebar-right': this.aside,
            'c-sidebar-minimized': this.minimize && !this.unfoldable,
            'c-sidebar-unfoldable': this.minimize && this.unfoldable,
            'c-sidebar-overlaid': this.overlaid,
            'c-sidebar-show': this.openMobile === true,
            [`c-sidebar-${this.breakpoint}-show`]: (!!this.breakpoint) && this.openDesktop,
            [`c-sidebar-${this.colorScheme}`]: !!this.colorScheme,
            [`c-sidebar-${this.size}`]: !!this.size,
        });
        return classes;
    }
    ngOnInit() {
        this.stateToggleSubscribe();
        this.layoutChangeSubscribe();
        this.setInitialState();
    }
    layoutChangeSubscribe(subscribe = true) {
        const onDesktop = `(min-width: ${this.getDesktopBreakpoint})`;
        const onMobile = this.breakpoint === false ? `(max-width: ${this.getMobileBreakpoint})` : `(max-width: ${this.getDesktopBreakpoint})`;
        if (subscribe) {
            const layoutChanges = this.breakpointObserver.observe([
                onDesktop,
                onMobile,
            ]);
            this.layoutChangesSubscription = layoutChanges.subscribe(result => {
                this.isOnMobile = result.breakpoints[onMobile];
                this.isOnDesktop = result.breakpoints[onDesktop];
                const openMobile = this.isOnMobile ? false : this.isOpen ? this.isOpen : this.show;
                this.sidebarService.toggle({ open: openMobile, sidebar: this });
            });
        }
        else {
            this.layoutChangesSubscription.unsubscribe();
        }
    }
    ngOnDestroy() {
        this.stateToggleSubscribe(false);
        this.layoutChangeSubscribe(false);
    }
    setInitialState() {
        this.openMobile = this.isOnDesktop ? false : this.isOnMobile ? false : this.show;
        this.openDesktop = this.hasBreakpoint;
        this.sidebarService.toggle({ minimize: this.minimize, open: this.isOpen, sidebar: this });
    }
    getState() {
        return { opened: this.isOpen, minimized: this.minimized, id: this.id };
    }
    open(state) {
        const toggle = (state.open === 'toggle');
        if (this.isOnDesktop) {
            this.openDesktop = toggle ? !this.openDesktop : state.open;
            this.openMobile = false;
        }
        else {
            this.openMobile = toggle ? !this.openMobile : state.open;
            if (this.openMobile && this.isOnMobile) {
                this.setBackdrop();
            }
            else {
                this.clearBackdrop();
            }
        }
    }
    stateToggleSubscribe(subscribe = true) {
        if (subscribe) {
            this.stateToggleSubscription = this.sidebarService.sidebarState$.subscribe((state) => {
                if (this === state.sidebar || this.id === state.id) {
                    if ('minimize' in state) {
                        this.minimizeSidebar(state);
                    }
                    if ('open' in state) {
                        this.open(state);
                    }
                }
            });
        }
        else {
            this.stateToggleSubscription.unsubscribe();
        }
    }
    hideMobile(e) {
        if (this.isOpen) {
            if (!e.target.closest('[cSidebarNavDropdownToggle]')) {
                this.sidebarService.toggle({ open: false, sidebar: this });
            }
        }
    }
    setBackdrop() {
        const backdrop = this.document.getElementsByClassName('c-sidebar-backdrop');
        if (backdrop.length === 0) {
            this.backdrop = this.renderer.createElement('div');
            this.renderer.addClass(this.backdrop, 'c-sidebar-backdrop');
            this.renderer.appendChild(this.document.body, this.backdrop);
            this.renderer.listen(this.backdrop, 'click', (e) => {
                this.hideMobile(e);
            });
        }
        if (this.backdrop && this.isOnMobile && this.isOpen) {
            this.renderer.addClass(this.backdrop, 'c-show');
            this.renderer.removeClass(this.backdrop, 'd-none');
        }
        else {
            this.renderer.addClass(this.backdrop, 'd-none');
            this.renderer.removeClass(this.backdrop, 'c-show');
        }
    }
    clearBackdrop() {
        if (this.backdrop) {
            this.renderer.listen(this.backdrop, 'click', (e) => { });
            this.renderer.removeChild(this.document.body, this.backdrop);
        }
    }
    minimizeSidebar(state) {
        const toggle = (state.minimize === 'toggle');
        this.minimize = toggle ? !this.minimize : !!state.minimize;
    }
    ngOnChanges(changes) {
        if (changes.breakpoint) {
            const { previousValue, currentValue } = Object.assign({}, changes.breakpoint);
            if (typeof currentValue === 'string') {
                this.renderer.addClass(this.hostElement.nativeElement, `c-sidebar-${currentValue}-show`);
            }
            this.renderer.removeClass(this.hostElement.nativeElement, `c-sidebar-${previousValue}-show`);
        }
        if (changes.size) {
            const { previousValue, currentValue } = Object.assign({}, changes.size);
            if (typeof currentValue === 'string') {
                this.renderer.addClass(this.hostElement.nativeElement, `c-sidebar-${currentValue}`);
            }
            this.renderer.removeClass(this.hostElement.nativeElement, `c-sidebar-${previousValue}`);
        }
        if (changes.colorScheme) {
            const { previousValue, currentValue } = Object.assign({}, changes.colorScheme);
            if (typeof currentValue === 'string') {
                this.renderer.addClass(this.hostElement.nativeElement, `c-sidebar-${currentValue}`);
            }
            this.renderer.removeClass(this.hostElement.nativeElement, `c-sidebar-${previousValue}`);
        }
    }
}
SidebarComponent.decorators = [
    { type: Component, args: [{
                selector: 'c-sidebar',
                exportAs: 'cSidebar',
                template: `<ng-content></ng-content>`
            },] }
];
SidebarComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Inject, args: [DOCUMENT,] }] },
    { type: Renderer2 },
    { type: ElementRef },
    { type: BreakpointObserver },
    { type: SidebarService }
];
SidebarComponent.propDecorators = {
    fixed: [{ type: Input }],
    unfoldable: [{ type: Input }],
    overlaid: [{ type: Input }],
    minimize: [{ type: Input }],
    breakpoint: [{ type: Input }],
    mobile: [{ type: Input }],
    show: [{ type: Input }],
    size: [{ type: Input }],
    aside: [{ type: Input }],
    hideOnMobileClick: [{ type: Input }],
    colorScheme: [{ type: Input }],
    id: [{ type: Input }],
    getClasses: [{ type: HostBinding, args: ['class',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lkZWJhci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jb3JldWktYW5ndWxhci9zcmMvbGliL3NpZGViYXIvc2lkZWJhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLFNBQVMsRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQWdDLFNBQVMsRUFBZ0IsTUFBTSxlQUFlLENBQUM7QUFDeEksT0FBTyxFQUFDLFFBQVEsRUFBQyxNQUFNLGlCQUFpQixDQUFDO0FBQ3pDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE9BQU8sVUFBVSxNQUFNLFlBQVksQ0FBQztBQUVwQyxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sbUJBQW1CLENBQUM7QUFRakQsTUFBTSxPQUFPLGdCQUFnQjtJQStGM0IsWUFDNEIsUUFBYSxFQUMvQixRQUFtQixFQUNuQixXQUF1QixFQUN2QixrQkFBc0MsRUFDdEMsY0FBOEI7UUFKWixhQUFRLEdBQVIsUUFBUSxDQUFLO1FBQy9CLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsZ0JBQVcsR0FBWCxXQUFXLENBQVk7UUFDdkIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxtQkFBYyxHQUFkLGNBQWMsQ0FBZ0I7UUFuRy9CLFVBQUssR0FBRyxJQUFJLENBQUM7UUFDYixlQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ25CLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFDakIsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixlQUFVLEdBQTJDLElBQUksQ0FBQztRQUMxRCxXQUFNLEdBQTJDLElBQUksQ0FBQztRQUV0RCxTQUFJLEdBQTRCLEVBQUUsQ0FBQztRQUVuQyxzQkFBaUIsR0FBRyxJQUFJLENBQUM7UUFDekIsZ0JBQVcsR0FBRyxNQUFNLENBQUM7UUFrQjlC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QUNELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGFBQWEsYUFBYSxFQUFFLENBQUMsQ0FBQztTQUN6RjtRQUNELElBQUksT0FBTyxDQUFDLFdBQVcsRUFBRTtZQUN2QixNQUFNLEVBQUMsYUFBYSxFQUFFLFlBQVksRUFBQyxxQkFBTyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDL0QsSUFBSSxPQUFPLFlBQVksS0FBSyxRQUFRLEVBQUU7Z0JBQ3BDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGFBQWEsWUFBWSxFQUFFLENBQUMsQ0FBQzthQUNyRjtZQUNELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsYUFBYSxFQUFFLGFBQWEsYUFBYSxFQUFFLENBQUMsQ0FBQztTQUN6RjtJQUNILENBQUM7OztZQXhRRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLFFBQVEsRUFBRSxVQUFVO2dCQUNwQixRQUFRLEVBQUUsMkJBQTJCO2FBQ3RDOzs7NENBaUdJLE1BQU0sU0FBQyxRQUFRO1lBOUdxRSxTQUFTO1lBQS9FLFVBQVU7WUFFckIsa0JBQWtCO1lBSWxCLGNBQWM7OztvQkFTbkIsS0FBSzt5QkFDTCxLQUFLO3VCQUNMLEtBQUs7dUJBQ0wsS0FBSzt5QkFDTCxLQUFLO3FCQUNMLEtBQUs7bUJBQ0wsS0FBSzttQkFDTCxLQUFLO29CQUNMLEtBQUs7Z0NBQ0wsS0FBSzswQkFDTCxLQUFLO2lCQUNMLEtBQUs7eUJBRUwsV0FBVyxTQUFDLE9BQU8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgRWxlbWVudFJlZiwgSG9zdEJpbmRpbmcsIEluamVjdCwgSW5wdXQsIE9uQ2hhbmdlcywgT25EZXN0cm95LCBPbkluaXQsIFJlbmRlcmVyMiwgU2ltcGxlQ2hhbmdlc30gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7RE9DVU1FTlR9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XHJcbmltcG9ydCB7QnJlYWtwb2ludE9ic2VydmVyfSBmcm9tICdAYW5ndWxhci9jZGsvbGF5b3V0JztcclxuaW1wb3J0IHtTdWJzY3JpcHRpb259IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgY2xhc3NOYW1lcyBmcm9tICdjbGFzc25hbWVzJztcclxuXHJcbmltcG9ydCB7U2lkZWJhclNlcnZpY2V9IGZyb20gJy4vc2lkZWJhci5zZXJ2aWNlJztcclxuLy8gaW1wb3J0IHtPdXRDbGlja1NlcnZpY2V9IGZyb20gXCIuLi9zaGFyZWRcIjtcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAnYy1zaWRlYmFyJyxcclxuICBleHBvcnRBczogJ2NTaWRlYmFyJyxcclxuICB0ZW1wbGF0ZTogYDxuZy1jb250ZW50PjwvbmctY29udGVudD5gXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBTaWRlYmFyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3ksIE9uQ2hhbmdlcyB7XHJcbiAgQElucHV0KCkgZml4ZWQgPSB0cnVlO1xyXG4gIEBJbnB1dCgpIHVuZm9sZGFibGUgPSBmYWxzZTtcclxuICBASW5wdXQoKSBvdmVybGFpZCA9IGZhbHNlO1xyXG4gIEBJbnB1dCgpIG1pbmltaXplID0gZmFsc2U7XHJcbiAgQElucHV0KCkgYnJlYWtwb2ludDogZmFsc2UgfCAnJyB8ICdzbScgfCAnbWQnIHwgJ2xnJyB8ICd4bCcgPSAnbGcnO1xyXG4gIEBJbnB1dCgpIG1vYmlsZTogZmFsc2UgfCAnJyB8ICdzbScgfCAnbWQnIHwgJ2xnJyB8ICd4bCcgPSAnbGcnO1xyXG4gIEBJbnB1dCgpIHNob3c6IGJvb2xlYW47XHJcbiAgQElucHV0KCkgc2l6ZTogJ3NtJyB8ICcnIHwgJ2xnJyB8ICd4bCcgPSAnJztcclxuICBASW5wdXQoKSBhc2lkZTogYm9vbGVhbjtcclxuICBASW5wdXQoKSBoaWRlT25Nb2JpbGVDbGljayA9IHRydWU7XHJcbiAgQElucHV0KCkgY29sb3JTY2hlbWUgPSAnZGFyayc7XHJcbiAgQElucHV0KCkgaWQ6IHN0cmluZztcclxuXHJcbiAgQEhvc3RCaW5kaW5nKCdjbGFzcycpXHJcbiAgZ2V0IGdldENsYXNzZXMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5ob3N0Q2xhc3NlcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX2lzT25Nb2JpbGU6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBfaXNPbkRlc2t0b3A6IGJvb2xlYW47XHJcbiAgcHJpdmF0ZSBzdGF0ZVRvZ2dsZVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgbGF5b3V0Q2hhbmdlc1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIC8vIHByaXZhdGUgb3V0Q2xpY2tTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIGJhY2tkcm9wOiBIVE1MRWxlbWVudDtcclxuXHJcbiAgLy8gc3RhdGVcclxuICBvcGVuTW9iaWxlO1xyXG4gIG9wZW5EZXNrdG9wO1xyXG4gIG1pbmltaXplZCA9IHRoaXMubWluaW1pemU7XHJcblxyXG4gIGdldCBnZXREZXNrdG9wQnJlYWtwb2ludCgpIHtcclxuICAgIHJldHVybiBnZXRDb21wdXRlZFN0eWxlKHRoaXMuaG9zdEVsZW1lbnQubmF0aXZlRWxlbWVudCkuZ2V0UHJvcGVydHlWYWx1ZShgLS1icmVha3BvaW50LSR7dGhpcy5icmVha3BvaW50fWApO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGhhc0JyZWFrcG9pbnQoKSB7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhgc2lkZWJhci0ke3RoaXMuaWR9YCwgJyBoYXNCcmVha3BvaW50JywgISF0aGlzLmJyZWFrcG9pbnQpO1xyXG4gICAgcmV0dXJuICEhdGhpcy5icmVha3BvaW50O1xyXG4gIH1cclxuXHJcbiAgZ2V0IGdldE1vYmlsZUJyZWFrcG9pbnQoKSB7XHJcbiAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmhvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUoYC0tYnJlYWtwb2ludC0ke3RoaXMubW9iaWxlfWApO1xyXG4gIH1cclxuXHJcbiAgc2V0IGlzT25Nb2JpbGUoIHZhbHVlKSB7XHJcbiAgICAvLyB0aGlzLl9pc09uTW9iaWxlID0gdmFsdWUgfHwgZ2V0Q29tcHV0ZWRTdHlsZSh0aGlzLmhvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUoJy0taXMtbW9iaWxlJykgPT09ICd0cnVlJztcclxuICAgIHRoaXMuX2lzT25Nb2JpbGUgPSB2YWx1ZTtcclxuICB9XHJcbiAgZ2V0IGlzT25Nb2JpbGUoKSB7XHJcbiAgICAvLyBjb25zdCBpc01vYmlsZSA9IGdldENvbXB1dGVkU3R5bGUodGhpcy5ob3N0RWxlbWVudC5uYXRpdmVFbGVtZW50KS5nZXRQcm9wZXJ0eVZhbHVlKCctLWlzLW1vYmlsZScpO1xyXG4gICAgY29uc3QgaXNNb2JpbGUgPSBCb29sZWFuKHRoaXMuX2lzT25Nb2JpbGUpO1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICcgaXNPbk1vYmlsZScsIEJvb2xlYW4oaXNNb2JpbGUpKTtcclxuICAgIHJldHVybiBpc01vYmlsZTtcclxuICB9XHJcblxyXG4gIHNldCBpc09uRGVza3RvcCh2YWx1ZSkge1xyXG4gICAgICB0aGlzLl9pc09uRGVza3RvcCA9IHRoaXMuaGFzQnJlYWtwb2ludCA/IHZhbHVlIDogZmFsc2U7XHJcbiAgfVxyXG4gIGdldCBpc09uRGVza3RvcCgpIHtcclxuICAgIC8vIGNvbnNvbGUubG9nKGBzaWRlYmFyLSR7dGhpcy5pZH1gLCAnIGlzT25EZXNrdG9wJywgdGhpcy5faXNPbkRlc2t0b3ApO1xyXG4gICAgcmV0dXJuIHRoaXMuX2lzT25EZXNrdG9wO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGlzT3BlbigpIHtcclxuICAgIGxldCBvcGVuZWQ7XHJcbiAgICBpZiAodGhpcy5pc09uRGVza3RvcCkge1xyXG4gICAgICAvLyBvcGVuZWQgPSB0aGlzLnJlc3BvbnNpdmUgPyB0cnVlIDogdGhpcy5vcGVuTW9iaWxlO1xyXG4gICAgICBvcGVuZWQgPSB0aGlzLm9wZW5EZXNrdG9wO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgb3BlbmVkID0gKHRoaXMub3Blbk1vYmlsZSA9PT0gdHJ1ZSk7XHJcbiAgICB9XHJcbiAgICAvLyBjb25zb2xlLmxvZyhgc2lkZWJhci0ke3RoaXMuaWR9YCwgJyBpc09wZW46Jywgb3BlbmVkLCAnZGVza3RvcCcsIHRoaXMub3BlbkRlc2t0b3AsICdtb2JpbGU6JywgdGhpcy5vcGVuTW9iaWxlKTtcclxuICAgIHJldHVybiBvcGVuZWQ7XHJcbiAgfVxyXG5cclxuICBnZXQgaG9zdENsYXNzZXMoKSB7XHJcblxyXG4gICAgY29uc3QgY2xhc3NlcyA9IGNsYXNzTmFtZXMoXHJcbiAgICAgIHtcclxuICAgICAgICAnYy1zaWRlYmFyJzogdHJ1ZSxcclxuICAgICAgICAnYy1zaWRlYmFyLWZpeGVkJzogdGhpcy5maXhlZCAmJiAhdGhpcy5vdmVybGFpZCxcclxuICAgICAgICAnYy1zaWRlYmFyLXJpZ2h0JzogdGhpcy5hc2lkZSxcclxuICAgICAgICAnYy1zaWRlYmFyLW1pbmltaXplZCc6IHRoaXMubWluaW1pemUgJiYgIXRoaXMudW5mb2xkYWJsZSxcclxuICAgICAgICAnYy1zaWRlYmFyLXVuZm9sZGFibGUnOiB0aGlzLm1pbmltaXplICYmIHRoaXMudW5mb2xkYWJsZSxcclxuICAgICAgICAnYy1zaWRlYmFyLW92ZXJsYWlkJzogdGhpcy5vdmVybGFpZCxcclxuICAgICAgICAnYy1zaWRlYmFyLXNob3cnOiB0aGlzLm9wZW5Nb2JpbGUgPT09IHRydWUsXHJcbiAgICAgICAgW2BjLXNpZGViYXItJHt0aGlzLmJyZWFrcG9pbnR9LXNob3dgXTogKCEhdGhpcy5icmVha3BvaW50KSAmJiB0aGlzLm9wZW5EZXNrdG9wLFxyXG4gICAgICAgIFtgYy1zaWRlYmFyLSR7dGhpcy5jb2xvclNjaGVtZX1gXTogISF0aGlzLmNvbG9yU2NoZW1lLFxyXG4gICAgICAgIFtgYy1zaWRlYmFyLSR7dGhpcy5zaXplfWBdOiAhIXRoaXMuc2l6ZSxcclxuICAgICAgfVxyXG4gICAgKTtcclxuICAgIC8vIGNvbnNvbGUubG9nKGBzaWRlYmFyLSR7dGhpcy5pZH1gLCAnIGNsYXNzZXMnLCBjbGFzc2VzICk7XHJcbiAgICByZXR1cm4gY2xhc3NlcztcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgQEluamVjdChET0NVTUVOVCkgcHJpdmF0ZSBkb2N1bWVudDogYW55LFxyXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxyXG4gICAgcHJpdmF0ZSBob3N0RWxlbWVudDogRWxlbWVudFJlZixcclxuICAgIHByaXZhdGUgYnJlYWtwb2ludE9ic2VydmVyOiBCcmVha3BvaW50T2JzZXJ2ZXIsXHJcbiAgICBwcml2YXRlIHNpZGViYXJTZXJ2aWNlOiBTaWRlYmFyU2VydmljZSxcclxuICAgIC8vIHByaXZhdGUgb3V0Q2xpY2tTZXJ2aWNlOiBPdXRDbGlja1NlcnZpY2VcclxuICApIHsgfVxyXG5cclxuICBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuc3RhdGVUb2dnbGVTdWJzY3JpYmUoKTtcclxuICAgIHRoaXMubGF5b3V0Q2hhbmdlU3Vic2NyaWJlKCk7XHJcbiAgICAvLyB0aGlzLm91dENsaWNrU3Vic2NyaWJlKClcclxuICAgIHRoaXMuc2V0SW5pdGlhbFN0YXRlKCk7XHJcbiAgICAvLyBjb25zb2xlLmxvZyhgc2lkZWJhci0ke3RoaXMuaWR9YCwgJyBuZ09uSW5pdCcsIHRoaXMuc2hvdywgdGhpcy5vcGVuRGVza3RvcCwgdGhpcy5vcGVuTW9iaWxlLCAnb25CcmVha3BvaW50JywgdGhpcy5pc09uRGVza3RvcCk7XHJcbiAgfVxyXG5cclxuICBsYXlvdXRDaGFuZ2VTdWJzY3JpYmUoc3Vic2NyaWJlOiBib29sZWFuID0gdHJ1ZSkge1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICdnZXREZXNrdG9wQnJlYWtwb2ludCcsIHRoaXMuZ2V0RGVza3RvcEJyZWFrcG9pbnQpXHJcbiAgICAvLyBjb25zb2xlLmxvZyhgc2lkZWJhci0ke3RoaXMuaWR9YCwgJ2dldE1vYmlsZUJyZWFrcG9pbnQnLCB0aGlzLmdldE1vYmlsZUJyZWFrcG9pbnQpXHJcbiAgICBjb25zdCBvbkRlc2t0b3AgPSBgKG1pbi13aWR0aDogJHt0aGlzLmdldERlc2t0b3BCcmVha3BvaW50fSlgO1xyXG4gICAgY29uc3Qgb25Nb2JpbGUgPSB0aGlzLmJyZWFrcG9pbnQgPT09IGZhbHNlID8gYChtYXgtd2lkdGg6ICR7dGhpcy5nZXRNb2JpbGVCcmVha3BvaW50fSlgIDogYChtYXgtd2lkdGg6ICR7dGhpcy5nZXREZXNrdG9wQnJlYWtwb2ludH0pYDtcclxuXHJcbiAgICBpZiAoc3Vic2NyaWJlKSB7XHJcbiAgICAgIGNvbnN0IGxheW91dENoYW5nZXMgPSB0aGlzLmJyZWFrcG9pbnRPYnNlcnZlci5vYnNlcnZlKFtcclxuICAgICAgICBvbkRlc2t0b3AsXHJcbiAgICAgICAgb25Nb2JpbGUsXHJcbiAgICAgIF0pO1xyXG5cclxuICAgICAgdGhpcy5sYXlvdXRDaGFuZ2VzU3Vic2NyaXB0aW9uID0gIGxheW91dENoYW5nZXMuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XHJcblxyXG4gICAgICAgIHRoaXMuaXNPbk1vYmlsZSA9IHJlc3VsdC5icmVha3BvaW50c1tvbk1vYmlsZV07XHJcbiAgICAgICAgdGhpcy5pc09uRGVza3RvcCA9IHJlc3VsdC5icmVha3BvaW50c1tvbkRlc2t0b3BdO1xyXG4gICAgICAgIGNvbnN0IG9wZW5Nb2JpbGUgPSB0aGlzLmlzT25Nb2JpbGUgPyBmYWxzZSA6IHRoaXMuaXNPcGVuID8gdGhpcy5pc09wZW4gOiB0aGlzLnNob3c7XHJcbiAgICAgICAgdGhpcy5zaWRlYmFyU2VydmljZS50b2dnbGUoe29wZW46IG9wZW5Nb2JpbGUsIHNpZGViYXI6IHRoaXN9KTtcclxuICAgICAgICAvLyBjb25zb2xlLmxvZyhgc2lkZWJhci0ke3RoaXMuaWR9YCwgJyBsYXlvdXRDaGFuZ2VzJywgcmVzdWx0LCAnb25Nb2JpbGUnLCB0aGlzLmlzT25Nb2JpbGUsICdvbkRlc2t0b3AnLCB0aGlzLmlzT25EZXNrdG9wKTtcclxuICAgICAgfSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmxheW91dENoYW5nZXNTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgLy8gdGhpcy5vdXRDbGlja1N1YnNjcmliZShmYWxzZSlcclxuICAgIHRoaXMuc3RhdGVUb2dnbGVTdWJzY3JpYmUoZmFsc2UpO1xyXG4gICAgdGhpcy5sYXlvdXRDaGFuZ2VTdWJzY3JpYmUoZmFsc2UpO1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICcgbmdPbkRlc3Ryb3knKTtcclxuICB9XHJcblxyXG4gIHNldEluaXRpYWxTdGF0ZSgpIHtcclxuICAgIHRoaXMub3Blbk1vYmlsZSA9IHRoaXMuaXNPbkRlc2t0b3AgPyBmYWxzZSA6IHRoaXMuaXNPbk1vYmlsZSA/IGZhbHNlIDogdGhpcy5zaG93O1xyXG4gICAgdGhpcy5vcGVuRGVza3RvcCA9IHRoaXMuaGFzQnJlYWtwb2ludDtcclxuICAgIC8vIGNvbnNvbGUubG9nKGBzaWRlYmFyLSR7dGhpcy5pZH1gLCAnIHNldFN0YXRlJywgJ21pbmltaXplZDonLCB0aGlzLm1pbmltaXplLCAnaXNPcGVuJywgdGhpcy5pc09wZW4sICd0aGlzLm9wZW5Nb2JpbGUnLCB0aGlzLm9wZW5Nb2JpbGVcclxuICAgIC8vICwgJ3RoaXMub3BlbkRlc2t0b3AnLCB0aGlzLm9wZW5EZXNrdG9wKTtcclxuICAgIHRoaXMuc2lkZWJhclNlcnZpY2UudG9nZ2xlKHttaW5pbWl6ZTogdGhpcy5taW5pbWl6ZSwgb3BlbjogdGhpcy5pc09wZW4sIHNpZGViYXI6IHRoaXN9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXRTdGF0ZSgpIHtcclxuICAgIHJldHVybiB7b3BlbmVkOiB0aGlzLmlzT3BlbiwgbWluaW1pemVkOiB0aGlzLm1pbmltaXplZCwgaWQ6IHRoaXMuaWR9O1xyXG4gIH1cclxuXHJcbiAgb3BlbihzdGF0ZTogYW55KTogdm9pZCB7XHJcbiAgICBjb25zdCB0b2dnbGUgPSAoc3RhdGUub3BlbiA9PT0gJ3RvZ2dsZScpO1xyXG4gICAgaWYgKHRoaXMuaXNPbkRlc2t0b3ApIHtcclxuICAgICAgdGhpcy5vcGVuRGVza3RvcCA9IHRvZ2dsZSA/ICF0aGlzLm9wZW5EZXNrdG9wIDogc3RhdGUub3BlbjtcclxuICAgICAgdGhpcy5vcGVuTW9iaWxlID0gZmFsc2U7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLm9wZW5Nb2JpbGUgPSB0b2dnbGUgPyAhdGhpcy5vcGVuTW9iaWxlIDogc3RhdGUub3BlbjtcclxuICAgICAgaWYgKHRoaXMub3Blbk1vYmlsZSAmJiB0aGlzLmlzT25Nb2JpbGUpIHtcclxuICAgICAgICB0aGlzLnNldEJhY2tkcm9wKCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5jbGVhckJhY2tkcm9wKCk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBtYXgtbGVuXHJcbiAgICAvLyBjb25zb2xlLmxvZygnYmFja2Ryb3A/JywgYHNpZGViYXItJHt0aGlzLmlkfWAsICcgb3BlbigpJywgJ29wZW5Nb2JpbGUnLCB0aGlzLm9wZW5Nb2JpbGUsICdvcGVuRGVza3RvcCcsIHRoaXMub3BlbkRlc2t0b3AsICdzdGF0ZS5vcGVuJywgc3RhdGUub3Blbik7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXRlVG9nZ2xlU3Vic2NyaWJlKHN1YnNjcmliZTogYm9vbGVhbiA9IHRydWUpIHtcclxuICAgIGlmIChzdWJzY3JpYmUpIHtcclxuICAgICAgdGhpcy5zdGF0ZVRvZ2dsZVN1YnNjcmlwdGlvbiA9IHRoaXMuc2lkZWJhclNlcnZpY2Uuc2lkZWJhclN0YXRlJC5zdWJzY3JpYmUoKHN0YXRlKSA9PiB7XHJcbiAgICAgICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICdzdWJzY3JpcHRpb24gc3RhdGUnLCBzdGF0ZSk7XHJcbiAgICAgICAgaWYgKHRoaXMgPT09IHN0YXRlLnNpZGViYXIgfHwgdGhpcy5pZCA9PT0gc3RhdGUuaWQpIHtcclxuICAgICAgICAgIGlmICgnbWluaW1pemUnIGluIHN0YXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWluaW1pemVTaWRlYmFyKHN0YXRlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmICgnb3BlbicgaW4gc3RhdGUpIHtcclxuICAgICAgICAgICAgdGhpcy5vcGVuKHN0YXRlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5zdGF0ZVRvZ2dsZVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGhpZGVNb2JpbGUoZSkge1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICcgaGlkZU1vYmlsZScsIGUudGFyZ2V0LCBlKTtcclxuICAgIGlmICh0aGlzLmlzT3Blbikge1xyXG4gICAgICAvLyBpZiAoIWUudGFyZ2V0LmNsb3Nlc3QoJ1tjU2lkZWJhclRvZ2dsZV0nKSAmJiAhZS50YXJnZXQuY2xvc2VzdCgnW2NTaWRlYmFyTmF2RHJvcGRvd25Ub2dnbGVdJykpIHtcclxuICAgICAgaWYgKCFlLnRhcmdldC5jbG9zZXN0KCdbY1NpZGViYXJOYXZEcm9wZG93blRvZ2dsZV0nKSkge1xyXG4gICAgICAgICAgdGhpcy5zaWRlYmFyU2VydmljZS50b2dnbGUoe29wZW46IGZhbHNlLCBzaWRlYmFyOiB0aGlzfSk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIHNldEJhY2tkcm9wKCkge1xyXG4gICAgY29uc3QgYmFja2Ryb3AgPSB0aGlzLmRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ2Mtc2lkZWJhci1iYWNrZHJvcCcpO1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICcgc2V0QmFja2Ryb3AnLCBiYWNrZHJvcCk7XHJcbiAgICBpZiAoYmFja2Ryb3AubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgIHRoaXMuYmFja2Ryb3AgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuYmFja2Ryb3AsICdjLXNpZGViYXItYmFja2Ryb3AnKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5hcHBlbmRDaGlsZCh0aGlzLmRvY3VtZW50LmJvZHksIHRoaXMuYmFja2Ryb3ApO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmxpc3Rlbih0aGlzLmJhY2tkcm9wLCAnY2xpY2snLCAoZSkgPT4ge1xyXG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGBzaWRlYmFyLSR7dGhpcy5pZH1gLCAnIGJhY2tkcm9wIGNsaWNrJywgZSk7XHJcbiAgICAgICAgdGhpcy5oaWRlTW9iaWxlKGUpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICh0aGlzLmJhY2tkcm9wICYmIHRoaXMuaXNPbk1vYmlsZSAmJiB0aGlzLmlzT3Blbikge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuYmFja2Ryb3AsICdjLXNob3cnKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmJhY2tkcm9wLCAnZC1ub25lJyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHRoaXMuYmFja2Ryb3AsICdkLW5vbmUnKTtcclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmJhY2tkcm9wLCAnYy1zaG93Jyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBjbGVhckJhY2tkcm9wKCkge1xyXG4gICAgLy8gY29uc29sZS5sb2coYHNpZGViYXItJHt0aGlzLmlkfWAsICcgY2xlYXJCYWNrZHJvcCcsIHRoaXMuYmFja2Ryb3ApO1xyXG4gICAgaWYgKHRoaXMuYmFja2Ryb3ApIHtcclxuICAgICAgLy8gdGhpcy5yZW5kZXJlci5saXN0ZW4odGhpcy5kb2N1bWVudCwgJ2NsaWNrJywgKGUpID0+IHt9ICk7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIubGlzdGVuKHRoaXMuYmFja2Ryb3AsICdjbGljaycsIChlKSA9PiB7fSApO1xyXG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNoaWxkKHRoaXMuZG9jdW1lbnQuYm9keSwgdGhpcy5iYWNrZHJvcCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBtaW5pbWl6ZVNpZGViYXIoc3RhdGUpIHtcclxuICAgIGNvbnN0IHRvZ2dsZSA9IChzdGF0ZS5taW5pbWl6ZSA9PT0gJ3RvZ2dsZScpO1xyXG4gICAgdGhpcy5taW5pbWl6ZSA9IHRvZ2dsZSA/ICF0aGlzLm1pbmltaXplIDogISFzdGF0ZS5taW5pbWl6ZTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpOiB2b2lkIHtcclxuICAgIC8vIGNvbnNvbGUubG9nKGBzaWRlYmFyLSR7dGhpcy5pZH1gLCAnIG5nT25DaGFuZ2VzJywgY2hhbmdlcylcclxuICAgIGlmIChjaGFuZ2VzLmJyZWFrcG9pbnQpIHtcclxuICAgICAgY29uc3Qge3ByZXZpb3VzVmFsdWUsIGN1cnJlbnRWYWx1ZX0gPSB7Li4uY2hhbmdlcy5icmVha3BvaW50fTtcclxuICAgICAgaWYgKHR5cGVvZiBjdXJyZW50VmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmhvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGBjLXNpZGViYXItJHtjdXJyZW50VmFsdWV9LXNob3dgKTtcclxuICAgICAgfVxyXG4gICAgICB0aGlzLnJlbmRlcmVyLnJlbW92ZUNsYXNzKHRoaXMuaG9zdEVsZW1lbnQubmF0aXZlRWxlbWVudCwgYGMtc2lkZWJhci0ke3ByZXZpb3VzVmFsdWV9LXNob3dgKTtcclxuICAgIH1cclxuICAgIGlmIChjaGFuZ2VzLnNpemUpIHtcclxuICAgICAgY29uc3Qge3ByZXZpb3VzVmFsdWUsIGN1cnJlbnRWYWx1ZX0gPSB7Li4uY2hhbmdlcy5zaXplfTtcclxuICAgICAgaWYgKHR5cGVvZiBjdXJyZW50VmFsdWUgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLmhvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGBjLXNpZGViYXItJHtjdXJyZW50VmFsdWV9YCk7XHJcbiAgICAgIH1cclxuICAgICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLmhvc3RFbGVtZW50Lm5hdGl2ZUVsZW1lbnQsIGBjLXNpZGViYXItJHtwcmV2aW91c1ZhbHVlfWApO1xyXG4gICAgfVxyXG4gICAgaWYgKGNoYW5nZXMuY29sb3JTY2hlbWUpIHtcclxuICAgICAgY29uc3Qge3ByZXZpb3VzVmFsdWUsIGN1cnJlbnRWYWx1ZX0gPSB7Li4uY2hhbmdlcy5jb2xvclNjaGVtZX07XHJcbiAgICAgIGlmICh0eXBlb2YgY3VycmVudFZhbHVlID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3ModGhpcy5ob3N0RWxlbWVudC5uYXRpdmVFbGVtZW50LCBgYy1zaWRlYmFyLSR7Y3VycmVudFZhbHVlfWApO1xyXG4gICAgICB9XHJcbiAgICAgIHRoaXMucmVuZGVyZXIucmVtb3ZlQ2xhc3ModGhpcy5ob3N0RWxlbWVudC5uYXRpdmVFbGVtZW50LCBgYy1zaWRlYmFyLSR7cHJldmlvdXNWYWx1ZX1gKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIHByaXZhdGUgb3V0Q2xpY2tTdWJzY3JpYmUoc3Vic2NyaWJlOiBCb29sZWFuID0gdHJ1ZSkge1xyXG4gIC8vICAgaWYgKHN1YnNjcmliZSkge1xyXG4gIC8vICAgICB0aGlzLm91dENsaWNrU3Vic2NyaXB0aW9uID0gdGhpcy5vdXRDbGlja1NlcnZpY2Uub3V0Q2xpY2skLnN1YnNjcmliZShtZXNzYWdlID0+IHtcclxuICAvLyAgICAgICBpZiAobWVzc2FnZS5ldmVudCkge1xyXG4gIC8vICAgICAgICAgdGhpcy5oaWRlTW9iaWxlKG1lc3NhZ2UuZXZlbnQpO1xyXG4gIC8vICAgICAgIH1cclxuICAvLyAgICAgfSk7XHJcbiAgLy8gICB9IGVsc2Uge1xyXG4gIC8vICAgICB0aGlzLm91dENsaWNrU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgLy8gICB9XHJcbiAgLy8gfVxyXG5cclxufVxyXG4iXX0=