import { Directive, Input, EventEmitter, IterableDiffers, Output } from "@angular/core";
import { ReplaySubject } from "rxjs";
export class DataTable {
    constructor(differs) {
        this.differs = differs;
        this.inputData = [];
        this.sortBy = "";
        this.sortOrder = "asc";
        this.sortByChange = new EventEmitter();
        this.sortOrderChange = new EventEmitter();
        this.rowsOnPage = 1000;
        this.activePage = 1;
        this.mustRecalculateData = false;
        this.onSortChange = new ReplaySubject(1);
        this.onPageChange = new EventEmitter();
        this.diff = differs.find([]).create(null);
    }
    getSort() {
        return { sortBy: this.sortBy, sortOrder: this.sortOrder };
    }
    setSort(sortBy, sortOrder) {
        if (this.sortBy !== sortBy || this.sortOrder !== sortOrder) {
            this.sortBy = sortBy;
            this.sortOrder = ["asc", "desc"].indexOf(sortOrder) >= 0 ? sortOrder : "asc";
            this.mustRecalculateData = true;
            this.onSortChange.next({ sortBy: this.sortBy, sortOrder: this.sortOrder });
            this.sortByChange.emit(this.sortBy);
            this.sortOrderChange.emit(this.sortOrder);
        }
    }
    getPage() {
        return { activePage: this.activePage, rowsOnPage: this.rowsOnPage, dataLength: this.inputData.length };
    }
    setPage(activePage, rowsOnPage) {
        if (this.rowsOnPage !== rowsOnPage || this.activePage !== activePage) {
            this.activePage = this.activePage !== activePage ? activePage : this.calculateNewActivePage(this.rowsOnPage, rowsOnPage);
            this.rowsOnPage = rowsOnPage;
            this.mustRecalculateData = true;
            this.onPageChange.emit({
                activePage: this.activePage,
                rowsOnPage: this.rowsOnPage,
                dataLength: this.inputData ? this.inputData.length : 0
            });
        }
    }
    calculateNewActivePage(previousRowsOnPage, currentRowsOnPage) {
        const firstRowOnPage = (this.activePage - 1) * previousRowsOnPage + 1;
        const newActivePage = Math.ceil(firstRowOnPage / currentRowsOnPage);
        return newActivePage;
    }
    recalculatePage() {
        const lastPage = Math.ceil(this.inputData.length / this.rowsOnPage);
        this.activePage = lastPage < this.activePage ? lastPage : this.activePage;
        this.activePage = this.activePage || 1;
        this.onPageChange.emit({
            activePage: this.activePage,
            rowsOnPage: this.rowsOnPage,
            dataLength: this.inputData.length
        });
    }
    ngOnChanges(changes) {
        if (changes.rowsOnPage) {
            this.rowsOnPage = changes.rowsOnPage.previousValue;
            this.setPage(this.activePage, changes.rowsOnPage.currentValue);
            this.mustRecalculateData = true;
        }
        if (changes.sortBy || changes.sortOrder) {
            if (["asc", "desc"].indexOf(this.sortOrder) < 0) {
                console.warn("ng-datatable: value for input mfSortOrder must be one of ['asc', 'desc'], but is:", this.sortOrder);
                this.sortOrder = "asc";
            }
            if (this.sortBy) {
                this.onSortChange.next({ sortBy: this.sortBy, sortOrder: this.sortOrder });
            }
            this.mustRecalculateData = true;
        }
        if (changes.inputData) {
            this.inputData = changes.inputData.currentValue || [];
            this.recalculatePage();
            this.mustRecalculateData = true;
        }
    }
    ngDoCheck() {
        const changes = this.diff.diff(this.inputData);
        if (changes) {
            this.recalculatePage();
            this.mustRecalculateData = true;
        }
        if (this.mustRecalculateData) {
            this.fillData();
            this.mustRecalculateData = false;
        }
    }
    fillData() {
        // this.activePage = this.activePage;
        // this.rowsOnPage = this.rowsOnPage;
        const offset = (this.activePage - 1) * this.rowsOnPage;
        // let data = this.inputData;
        // const sortBy = this.sortBy;
        // if (typeof sortBy === "string" || sortBy instanceof String) {
        //     data = orderBy(data, this.caseInsensitiveIteratee(sortBy as string), [this.sortOrder]);
        // } else {
        //     data = orderBy(data, sortBy, [this.sortOrder]);
        // }
        // data = slice(data, offset, offset + this.rowsOnPage);
        this.data = [...this.inputData]
            .sort(this.sorter(this.sortBy, this.sortOrder))
            .slice(offset, offset + this.rowsOnPage);
    }
    caseInsensitiveIteratee(sortBy) {
        return (row) => {
            let value = row;
            if (typeof sortBy === "string" || sortBy instanceof String) {
                for (const sortByProperty of sortBy.split(".")) {
                    if (value) {
                        value = value[sortByProperty];
                    }
                }
            }
            else {
                value = sortBy(value);
            }
            if (value && typeof value === "string" || value instanceof String) {
                return value.toLowerCase();
            }
            return value;
        };
    }
    compare(left, right) {
        return left === right ? 0 : left == null || left > right ? 1 : -1;
    }
    sorter(sortBy, sortOrder) {
        const order = sortOrder === "desc" ? -1 : 1;
        if (Array.isArray(sortBy)) {
            const iteratees = sortBy.map((entry) => this.caseInsensitiveIteratee(entry));
            return (left, right) => {
                for (const iteratee of iteratees) {
                    const comparison = this.compare(iteratee(left), iteratee(right)) * order;
                    if (comparison !== 0) {
                        return comparison;
                    }
                }
                return 0;
            };
        }
        else {
            const iteratee = this.caseInsensitiveIteratee(sortBy);
            return (left, right) => this.compare(iteratee(left), iteratee(right)) * order;
        }
    }
}
DataTable.decorators = [
    { type: Directive, args: [{
                selector: "table[mfData]",
                exportAs: "mfDataTable"
            },] }
];
DataTable.ctorParameters = () => [
    { type: IterableDiffers }
];
DataTable.propDecorators = {
    inputData: [{ type: Input, args: ["mfData",] }],
    sortBy: [{ type: Input, args: ["mfSortBy",] }],
    sortOrder: [{ type: Input, args: ["mfSortOrder",] }],
    sortByChange: [{ type: Output, args: ["mfSortByChange",] }],
    sortOrderChange: [{ type: Output, args: ["mfSortOrderChange",] }],
    rowsOnPage: [{ type: Input, args: ["mfRowsOnPage",] }],
    activePage: [{ type: Input, args: ["mfActivePage",] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0YVRhYmxlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uL3Byb2plY3RzL25nLWRhdGF0YWJsZS9zcmMvIiwic291cmNlcyI6WyJsaWIvRGF0YVRhYmxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDSCxTQUFTLEVBQUUsS0FBSyxFQUFFLFlBQVksRUFBb0MsZUFBZSxFQUNqRSxNQUFNLEVBQ3pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFxQnJDLE1BQU0sT0FBTyxTQUFTO0lBb0JsQixZQUEyQixPQUF3QjtRQUF4QixZQUFPLEdBQVAsT0FBTyxDQUFpQjtRQWpCM0IsY0FBUyxHQUFVLEVBQUUsQ0FBQztRQUVwQixXQUFNLEdBQThDLEVBQUUsQ0FBQztRQUNwRCxjQUFTLEdBQW1CLEtBQUssQ0FBQztRQUM5QixpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFxQixDQUFDO1FBQ2xELG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUVuRCxlQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLGVBQVUsR0FBRyxDQUFDLENBQUM7UUFFckMsd0JBQW1CLEdBQUcsS0FBSyxDQUFDO1FBSTdCLGlCQUFZLEdBQUcsSUFBSSxhQUFhLENBQVksQ0FBQyxDQUFDLENBQUM7UUFDL0MsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBYSxDQUFDO1FBR2hELElBQUksQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUVNLE9BQU87UUFDVixPQUFPLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztJQUM5RCxDQUFDO0lBRU0sT0FBTyxDQUFDLE1BQXlCLEVBQUUsU0FBeUI7UUFDL0QsSUFBSSxJQUFJ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QUFDLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO29CQUN6RSxJQUFJLFVBQVUsS0FBSyxDQUFDLEVBQUU7d0JBQ2xCLE9BQU8sVUFBVSxDQUFDO3FCQUNyQjtpQkFDSjtnQkFDRCxPQUFPLENBQUMsQ0FBQztZQUNiLENBQUMsQ0FBQztTQUNMO2FBQU07WUFDSCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsdUJBQXVCLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdEQsT0FBTyxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQztTQUNqRjtJQUNMLENBQUM7OztZQTlLSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGVBQWU7Z0JBQ3pCLFFBQVEsRUFBRSxhQUFhO2FBQzFCOzs7WUF2QnFFLGVBQWU7Ozt3QkEyQmhGLEtBQUssU0FBQyxRQUFRO3FCQUVkLEtBQUssU0FBQyxVQUFVO3dCQUNoQixLQUFLLFNBQUMsYUFBYTsyQkFDbkIsTUFBTSxTQUFDLGdCQUFnQjs4QkFDdkIsTUFBTSxTQUFDLG1CQUFtQjt5QkFFMUIsS0FBSyxTQUFDLGNBQWM7eUJBQ3BCLEtBQUssU0FBQyxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIERpcmVjdGl2ZSwgSW5wdXQsIEV2ZW50RW1pdHRlciwgU2ltcGxlQ2hhbmdlLCBPbkNoYW5nZXMsIERvQ2hlY2ssIEl0ZXJhYmxlRGlmZmVycyxcclxuICAgIEl0ZXJhYmxlRGlmZmVyLCBPdXRwdXRcclxufSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xyXG5pbXBvcnQgeyBSZXBsYXlTdWJqZWN0IH0gZnJvbSBcInJ4anNcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgU29ydEV2ZW50IHtcclxuICAgIHNvcnRCeTogc3RyaW5nIHwgc3RyaW5nW10gfCBGdW5jdGlvbiB8IEZ1bmN0aW9uW107XHJcbiAgICBzb3J0T3JkZXI6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBQYWdlRXZlbnQge1xyXG4gICAgYWN0aXZlUGFnZTogbnVtYmVyO1xyXG4gICAgcm93c09uUGFnZTogbnVtYmVyO1xyXG4gICAgZGF0YUxlbmd0aDogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFFdmVudCB7XHJcbiAgICBsZW5ndGg6IG51bWJlcjtcclxufVxyXG5cclxuQERpcmVjdGl2ZSh7XHJcbiAgICBzZWxlY3RvcjogXCJ0YWJsZVttZkRhdGFdXCIsXHJcbiAgICBleHBvcnRBczogXCJtZkRhdGFUYWJsZVwiXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBEYXRhVGFibGUgaW1wbGVtZW50cyBPbkNoYW5nZXMsIERvQ2hlY2sge1xyXG5cclxuICAgIHByaXZhdGUgZGlmZjogSXRlcmFibGVEaWZmZXI8YW55PjtcclxuICAgIEBJbnB1dChcIm1mRGF0YVwiKSBwdWJsaWMgaW5wdXREYXRhOiBhbnlbXSA9IFtdO1xyXG5cclxuICAgIEBJbnB1dChcIm1mU29ydEJ5XCIpIHB1YmxpYyBzb3J0Qnk6IHN0cmluZyB8IHN0cmluZ1tdIHwgRnVuY3Rpb24gfCBGdW5jdGlvbltdID0gXCJcIjtcclxuICAgIEBJbnB1dChcIm1mU29ydE9yZGVyXCIpIHB1YmxpYyBzb3J0T3JkZXI6IFwiYXNjXCIgfCBcImRlc2NcIiA9IFwiYXNjXCI7XHJcbiAgICBAT3V0cHV0KFwibWZTb3J0QnlDaGFuZ2VcIikgcHVibGljIHNvcnRCeUNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nIHwgc3RyaW5nW10+KCk7XHJcbiAgICBAT3V0cHV0KFwibWZTb3J0T3JkZXJDaGFuZ2VcIikgcHVibGljIHNvcnRPcmRlckNoYW5nZSA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xyXG5cclxuICAgIEBJbnB1dChcIm1mUm93c09uUGFnZVwiKSBwdWJsaWMgcm93c09uUGFnZSA9IDEwMDA7XHJcbiAgICBASW5wdXQoXCJtZkFjdGl2ZVBhZ2VcIikgcHVibGljIGFjdGl2ZVBhZ2UgPSAxO1xyXG5cclxuICAgIHByaXZhdGUgbXVzdFJlY2FsY3VsYXRlRGF0YSA9IGZhbHNlO1xyXG5cclxuICAgIHB1YmxpYyBkYXRhOiBhbnlbXTtcclxuXHJcbiAgICBwdWJsaWMgb25Tb3J0Q2hhbmdlID0gbmV3IFJlcGxheVN1YmplY3Q8U29ydEV2ZW50PigxKTtcclxuICAgIHB1YmxpYyBvblBhZ2VDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPFBhZ2VFdmVudD4oKTtcclxuXHJcbiAgICBwdWJsaWMgY29uc3RydWN0b3IocHJpdmF0ZSBkaWZmZXJzOiBJdGVyYWJsZURpZmZlcnMpIHtcclxuICAgICAgICB0aGlzLmRpZmYgPSBkaWZmZXJzLmZpbmQoW10pLmNyZWF0ZShudWxsKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0U29ydCgpOiBTb3J0RXZlbnQge1xyXG4gICAgICAgIHJldHVybiB7IHNvcnRCeTogdGhpcy5zb3J0QnksIHNvcnRPcmRlcjogdGhpcy5zb3J0T3JkZXIgfTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0U29ydChzb3J0Qnk6IHN0cmluZyB8IHN0cmluZ1tdLCBzb3J0T3JkZXI6IFwiYXNjXCIgfCBcImRlc2NcIik6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLnNvcnRCeSAhPT0gc29ydEJ5IHx8IHRoaXMuc29ydE9yZGVyICE9PSBzb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5zb3J0QnkgPSBzb3J0Qnk7XHJcbiAgICAgICAgICAgIHRoaXMuc29ydE9yZGVyID0gW1wiYXNjXCIsIFwiZGVzY1wiXS5pbmRleE9mKHNvcnRPcmRlcikgPj0gMCA/IHNvcnRPcmRlciA6IFwiYXNjXCI7XHJcbiAgICAgICAgICAgIHRoaXMubXVzdFJlY2FsY3VsYXRlRGF0YSA9IHRydWU7XHJcbiAgICAgICAgICAgIHRoaXMub25Tb3J0Q2hhbmdlLm5leHQoeyBzb3J0Qnk6IHRoaXMuc29ydEJ5LCBzb3J0T3JkZXI6IHRoaXMuc29ydE9yZGVyIH0pO1xyXG4gICAgICAgICAgICB0aGlzLnNvcnRCeUNoYW5nZS5lbWl0KHRoaXMuc29ydEJ5KTtcclxuICAgICAgICAgICAgdGhpcy5zb3J0T3JkZXJDaGFuZ2UuZW1pdCh0aGlzLnNvcnRPcmRlcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXRQYWdlKCk6IFBhZ2VFdmVudCB7XHJcbiAgICAgICAgcmV0dXJuIHsgYWN0aXZlUGFnZTogdGhpcy5hY3RpdmVQYWdlLCByb3dzT25QYWdlOiB0aGlzLnJvd3NPblBhZ2UsIGRhdGFMZW5ndGg6IHRoaXMuaW5wdXREYXRhLmxlbmd0aCB9O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRQYWdlKGFjdGl2ZVBhZ2U6IG51bWJlciwgcm93c09uUGFnZTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMucm93c09uUGFnZSAhPT0gcm93c09uUGFnZSB8fCB0aGlzLmFjdGl2ZVBhZ2UgIT09IGFjdGl2ZVBhZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5hY3RpdmVQYWdlID0gdGhpcy5hY3RpdmVQYWdlICE9PSBhY3RpdmVQYWdlID8gYWN0aXZlUGFnZSA6IHRoaXMuY2FsY3VsYXRlTmV3QWN0aXZlUGFnZSh0aGlzLnJvd3NPblBhZ2UsIHJvd3NPblBhZ2UpO1xyXG4gICAgICAgICAgICB0aGlzLnJvd3NPblBhZ2UgPSByb3dzT25QYWdlO1xyXG4gICAgICAgICAgICB0aGlzLm11c3RSZWNhbGN1bGF0ZURhdGEgPSB0cnVlO1xyXG4gICAgICAgICAgICB0aGlzLm9uUGFnZUNoYW5nZS5lbWl0KHtcclxuICAgICAgICAgICAgICAgIGFjdGl2ZVBhZ2U6IHRoaXMuYWN0aXZlUGFnZSxcclxuICAgICAgICAgICAgICAgIHJvd3NPblBhZ2U6IHRoaXMucm93c09uUGFnZSxcclxuICAgICAgICAgICAgICAgIGRhdGFMZW5ndGg6IHRoaXMuaW5wdXREYXRhID8gdGhpcy5pbnB1dERhdGEubGVuZ3RoIDogMFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjYWxjdWxhdGVOZXdBY3RpdmVQYWdlKHByZXZpb3VzUm93c09uUGFnZTogbnVtYmVyLCBjdXJyZW50Um93c09uUGFnZTogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgICAgICBjb25zdCBmaXJzdFJvd09uUGFnZSA9ICh0aGlzLmFjdGl2ZVBhZ2UgLSAxKSAqIHByZXZpb3VzUm93c09uUGFnZSArIDE7XHJcbiAgICAgICAgY29uc3QgbmV3QWN0aXZlUGFnZSA9IE1hdGguY2VpbChmaXJzdFJvd09uUGFnZSAvIGN1cnJlbnRSb3dzT25QYWdlKTtcclxuICAgICAgICByZXR1cm4gbmV3QWN0aXZlUGFnZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlY2FsY3VsYXRlUGFnZSgpIHtcclxuICAgICAgICBjb25zdCBsYXN0UGFnZSA9IE1hdGguY2VpbCh0aGlzLmlucHV0RGF0YS5sZW5ndGggLyB0aGlzLnJvd3NPblBhZ2UpO1xyXG4gICAgICAgIHRoaXMuYWN0aXZlUGFnZSA9IGxhc3RQYWdlIDwgdGhpcy5hY3RpdmVQYWdlID8gbGFzdFBhZ2UgOiB0aGlzLmFjdGl2ZVBhZ2U7XHJcbiAgICAgICAgdGhpcy5hY3RpdmVQYWdlID0gdGhpcy5hY3RpdmVQYWdlIHx8IDE7XHJcblxyXG4gICAgICAgIHRoaXMub25QYWdlQ2hhbmdlLmVtaXQoe1xyXG4gICAgICAgICAgICBhY3RpdmVQYWdlOiB0aGlzLmFjdGl2ZVBhZ2UsXHJcbiAgICAgICAgICAgIHJvd3NPblBhZ2U6IHRoaXMucm93c09uUGFnZSxcclxuICAgICAgICAgICAgZGF0YUxlbmd0aDogdGhpcy5pbnB1dERhdGEubGVuZ3RoXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG5nT25DaGFuZ2VzKGNoYW5nZXM6IHsgW2tleTogc3RyaW5nXTogU2ltcGxlQ2hhbmdlIH0pOiBhbnkge1xyXG4gICAgICAgIGlmIChjaGFuZ2VzLnJvd3NPblBhZ2UpIHtcclxuICAgICAgICAgICAgdGhpcy5yb3dzT25QYWdlID0gY2hhbmdlcy5yb3dzT25QYWdlLnByZXZpb3VzVmFsdWU7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0UGFnZSh0aGlzLmFjdGl2ZVBhZ2UsIGNoYW5nZXMucm93c09uUGFnZS5jdXJyZW50VmFsdWUpO1xyXG4gICAgICAgICAgICB0aGlzLm11c3RSZWNhbGN1bGF0ZURhdGEgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY2hhbmdlcy5zb3J0QnkgfHwgY2hhbmdlcy5zb3J0T3JkZXIpIHtcclxuICAgICAgICAgICAgaWYgKFtcImFzY1wiLCBcImRlc2NcIl0uaW5kZXhPZih0aGlzLnNvcnRPcmRlcikgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oXCJuZy1kYXRhdGFibGU6IHZhbHVlIGZvciBpbnB1dCBtZlNvcnRPcmRlciBtdXN0IGJlIG9uZSBvZiBbJ2FzYycsICdkZXNjJ10sIGJ1dCBpczpcIiwgdGhpcy5zb3J0T3JkZXIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zb3J0T3JkZXIgPSBcImFzY1wiO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnNvcnRCeSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5vblNvcnRDaGFuZ2UubmV4dCh7IHNvcnRCeTogdGhpcy5zb3J0QnksIHNvcnRPcmRlcjogdGhpcy5zb3J0T3JkZXIgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5tdXN0UmVjYWxjdWxhdGVEYXRhID0gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNoYW5nZXMuaW5wdXREYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuaW5wdXREYXRhID0gY2hhbmdlcy5pbnB1dERhdGEuY3VycmVudFZhbHVlIHx8IFtdO1xyXG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlUGFnZSgpO1xyXG4gICAgICAgICAgICB0aGlzLm11c3RSZWNhbGN1bGF0ZURhdGEgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbmdEb0NoZWNrKCk6IGFueSB7XHJcbiAgICAgICAgY29uc3QgY2hhbmdlcyA9IHRoaXMuZGlmZi5kaWZmKHRoaXMuaW5wdXREYXRhKTtcclxuICAgICAgICBpZiAoY2hhbmdlcykge1xyXG4gICAgICAgICAgICB0aGlzLnJlY2FsY3VsYXRlUGFnZSgpO1xyXG4gICAgICAgICAgICB0aGlzLm11c3RSZWNhbGN1bGF0ZURhdGEgPSB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5tdXN0UmVjYWxjdWxhdGVEYXRhKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZmlsbERhdGEoKTtcclxuICAgICAgICAgICAgdGhpcy5tdXN0UmVjYWxjdWxhdGVEYXRhID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgZmlsbERhdGEoKTogdm9pZCB7XHJcbiAgICAgICAgLy8gdGhpcy5hY3RpdmVQYWdlID0gdGhpcy5hY3RpdmVQYWdlO1xyXG4gICAgICAgIC8vIHRoaXMucm93c09uUGFnZSA9IHRoaXMucm93c09uUGFnZTtcclxuXHJcbiAgICAgICAgY29uc3Qgb2Zmc2V0ID0gKHRoaXMuYWN0aXZlUGFnZSAtIDEpICogdGhpcy5yb3dzT25QYWdlO1xyXG4gICAgICAgIC8vIGxldCBkYXRhID0gdGhpcy5pbnB1dERhdGE7XHJcbiAgICAgICAgLy8gY29uc3Qgc29ydEJ5ID0gdGhpcy5zb3J0Qnk7XHJcbiAgICAgICAgLy8gaWYgKHR5cGVvZiBzb3J0QnkgPT09IFwic3RyaW5nXCIgfHwgc29ydEJ5IGluc3RhbmNlb2YgU3RyaW5nKSB7XHJcbiAgICAgICAgLy8gICAgIGRhdGEgPSBvcmRlckJ5KGRhdGEsIHRoaXMuY2FzZUluc2Vuc2l0aXZlSXRlcmF0ZWUoc29ydEJ5IGFzIHN0cmluZyksIFt0aGlzLnNvcnRPcmRlcl0pO1xyXG4gICAgICAgIC8vIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gICAgIGRhdGEgPSBvcmRlckJ5KGRhdGEsIHNvcnRCeSwgW3RoaXMuc29ydE9yZGVyXSk7XHJcbiAgICAgICAgLy8gfVxyXG4gICAgICAgIC8vIGRhdGEgPSBzbGljZShkYXRhLCBvZmZzZXQsIG9mZnNldCArIHRoaXMucm93c09uUGFnZSk7XHJcblxyXG4gICAgICAgIHRoaXMuZGF0YSA9IFsuLi50aGlzLmlucHV0RGF0YV1cclxuICAgICAgICAgICAgLnNvcnQodGhpcy5zb3J0ZXIodGhpcy5zb3J0QnksIHRoaXMuc29ydE9yZGVyKSlcclxuICAgICAgICAgICAgLnNsaWNlKG9mZnNldCwgb2Zmc2V0ICsgdGhpcy5yb3dzT25QYWdlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNhc2VJbnNlbnNpdGl2ZUl0ZXJhdGVlKHNvcnRCeTogc3RyaW5nIHwgRnVuY3Rpb24pIHtcclxuICAgICAgICByZXR1cm4gKHJvdzogYW55KTogYW55ID0+IHtcclxuICAgICAgICAgICAgbGV0IHZhbHVlID0gcm93O1xyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHNvcnRCeSA9PT0gXCJzdHJpbmdcIiB8fCBzb3J0QnkgaW5zdGFuY2VvZiBTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgc29ydEJ5UHJvcGVydHkgb2Ygc29ydEJ5LnNwbGl0KFwiLlwiKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlW3NvcnRCeVByb3BlcnR5XTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSA9IHNvcnRCeSh2YWx1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiB0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCIgfHwgdmFsdWUgaW5zdGFuY2VvZiBTdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b0xvd2VyQ2FzZSgpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGNvbXBhcmUobGVmdDogYW55LCByaWdodDogYW55KTogbnVtYmVyIHtcclxuICAgICAgICByZXR1cm4gbGVmdCA9PT0gcmlnaHQgPyAwIDogbGVmdCA9PSBudWxsIHx8IGxlZnQgPiByaWdodCA/IDEgOiAtMTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNvcnRlcjxUPihzb3J0Qnk6IHN0cmluZyB8IEZ1bmN0aW9uIHwgKHN0cmluZyB8IEZ1bmN0aW9uKVtdLCBzb3J0T3JkZXI6IHN0cmluZyk6IChsZWZ0OiBULCByaWdodDogVCkgPT4gbnVtYmVyIHtcclxuICAgICAgICBjb25zdCBvcmRlciA9IHNvcnRPcmRlciA9PT0gXCJkZXNjXCIgPyAtMSA6IDE7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc29ydEJ5KSkge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVyYXRlZXMgPSBzb3J0QnkubWFwKChlbnRyeTogc3RyaW5nIHwgRnVuY3Rpb24pID0+IHRoaXMuY2FzZUluc2Vuc2l0aXZlSXRlcmF0ZWUoZW50cnkpKTtcclxuICAgICAgICAgICAgcmV0dXJuIChsZWZ0LCByaWdodCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVyYXRlZSBvZiBpdGVyYXRlZXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wYXJpc29uID0gdGhpcy5jb21wYXJlKGl0ZXJhdGVlKGxlZnQpLCBpdGVyYXRlZShyaWdodCkpICogb3JkZXI7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbXBhcmlzb24gIT09IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGNvbXBhcmlzb247XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIDA7XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgY29uc3QgaXRlcmF0ZWUgPSB0aGlzLmNhc2VJbnNlbnNpdGl2ZUl0ZXJhdGVlKHNvcnRCeSk7XHJcbiAgICAgICAgICAgIHJldHVybiAobGVmdCwgcmlnaHQpID0+IHRoaXMuY29tcGFyZShpdGVyYXRlZShsZWZ0KSwgaXRlcmF0ZWUocmlnaHQpKSAqIG9yZGVyO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxufVxyXG4iXX0=